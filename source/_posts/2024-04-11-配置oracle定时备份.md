---
title: 配置oracle定时备份
tag:
  - oracle
categories:
  - [oracle]
article_type: 0
no_word_count: false
no_toc: false
no_date: false
no_declare: false
no_reward: false
no_comments: false
no_share: false
no_footer: false
mathjax: false
typora-root-url: ./..
abbrlink: 8ab9b48c
date: 2024-04-11 15:56:08
top:
---

## Windows

### 准备内容

- 2345好压程序（用于压缩备份）
- oracle客户端程序（用于提供exp命令）

### 步骤

#### 安装好压

##### 配置好压到环境变量

##### 测试好压压缩命令

```
HaoZipC a -tzip 压缩文件名称.zip 需要压缩的目录
```

#### 编写exp脚本

- 配置目录H:\数据库备份\228数据库备份、H:\数据库备份\159数据库备份

<!--more-->

数据备份HaoZip_rb.bat：

```
@echo off
title 172.16.2.159和172.16.8.228实例备份
set dtm=%Date:~0,4%-%Date:~5,2%-%Date:~8,2%
REM 设置日志文件路径
set LOG_FILE_159=H:\数据库备份\batrun_log-159-%dtm%.txt
set LOG_FILE_228=H:\数据库备份\batrun_log-228-%dtm%.txt

echo ===%TIME%=== >> %LOG_FILE_159%
echo ===开始备份159=== >> %LOG_FILE_159%
echo ===在《H:\数据库备份\159数据库备份\》中新建以当前日期为名的文件夹%dtm%=== >> %LOG_FILE_159%
H: >> %LOG_FILE_159%
cd H:\数据库备份\159数据库备份 >> %LOG_FILE_159%
md H:\数据库备份\159数据库备份\%dtm% >> %LOG_FILE_159%

:: 全库备份
echo ===%TIME%=== >> %LOG_FILE_159%
echo ===开始备份 159(GHZJ_ORCL)=== >> %LOG_FILE_159%
exp GHZJ_TEST/xxx@172.16.2.159/ORCL  full=y  file=H:/数据库备份/159数据库备份/%dtm%/GHZJ_ORCL-%dtm%.dmp log=H:/数据库备份/159数据库备份/%dtm%/GHZJ_ORCL-%dtm%.log >> %LOG_FILE_159%
echo ===开始压缩 GHZJ_ORCL-%dtm%.dmp和 GHZJ_ORCL-%dtm%.log=== >> %LOG_FILE_159%
HaoZipC a -tzip  GHZJ_ORCL-%dtm%.zip H:\数据库备份\159数据库备份\%dtm%\GHZJ_ORCL-%dtm%.dmp  H:\数据库备份\159数据库备份\%dtm%\GHZJ_ORCL-%dtm%.log >> %LOG_FILE_159%
echo ===压缩完成,删除备份的文件 GHZJ_ORCL-%dtm%.dmp GHZJ_ORCL-%dtm%.log=== >> %LOG_FILE_159%
del H:\数据库备份\159数据库备份\%dtm%\GHZJ_ORCL-%dtm%.dmp >> %LOG_FILE_159%
del H:\数据库备份\159数据库备份\%dtm%\GHZJ_ORCL-%dtm%.log >> %LOG_FILE_159%

echo ===%TIME%=== >> %LOG_FILE_159%
echo ===开始备份 159(GHZJ_GHXGTEST)=== >> %LOG_FILE_159%
exp GHZJ_GHXGTEST/xxx@172.16.2.159/ghxgtest  full=y  file=H:/数据库备份/159数据库备份/%dtm%/GHZJ_GHXGTEST-%dtm%.dmp log=H:/数据库备份/159数据库备份/%dtm%/GHZJ_GHXGTEST-%dtm%.log >> %LOG_FILE_159%
echo ===开始压缩 GHZJ_GHXGTEST-%dtm%.dmp和 GHZJ_GHXGTEST-%dtm%.log=== >> %LOG_FILE_159%
HaoZipC a -tzip  GHZJ_GHXGTEST-%dtm%.zip H:\数据库备份\159数据库备份\%dtm%\GHZJ_GHXGTEST-%dtm%.dmp  H:\数据库备份\159数据库备份\%dtm%\GHZJ_GHXGTEST-%dtm%.log >> %LOG_FILE_159% 
echo ===压缩完成,删除备份的文件 GHZJ_GHXGTEST-%dtm%.dmp GHZJ_GHXGTEST-%dtm%.log=== >> %LOG_FILE_159%
del H:\数据库备份\159数据库备份\%dtm%\GHZJ_GHXGTEST-%dtm%.dmp >> %LOG_FILE_159%
del H:\数据库备份\159数据库备份\%dtm%\GHZJ_GHXGTEST-%dtm%.log >> %LOG_FILE_159%

:: 单独备份实例
:: echo ===开始备份159(GHZJ_TEST)===
:: exp GHZJ_TEST/xxx@172.16.2.159/ORCL compress=n buffer=65536 owner=GHZJ_TEST file=H:/数据库备份/159数据库备份/%dtm%/GHZJ_TEST-%dtm%.dmp log=H:/数据库备份/159数据库备份/%dtm%/GHZJ_TEST-%dtm%.log
:: echo ===开始压缩 GHZJ_TEST-%dtm%.dmp和 GHZJ_TEST-%dtm%.log===
:: HaoZipC a -tzip  GHZJ_TEST-%dtm%.zip H:\数据库备份\159数据库备份\%dtm%\GHZJ_TEST-%dtm%.dmp  H:\数据库备份\159数据库备份\%dtm%\GHZJ_TEST-%dtm%.log 
:: echo ===压缩完成,删除备份的文件 GHZJ_TEST-%dtm%.dmp GHZJ_TEST-%dtm%.log===
:: del H:\数据库备份\159数据库备份\%dtm%\GHZJ_TEST-%dtm%.dmp
:: del H:\数据库备份\159数据库备份\%dtm%\GHZJ_TEST-%dtm%.log
:: 
:: echo ===开始备份159(GHZJ_GHXGTEST)===
:: exp GHZJ_GHXGTEST/xxx@172.16.2.159/ghxgtest compress=n buffer=65536 owner=GHZJ_GHXGTEST file=H:/数据库备份/159数据库备份/%dtm%/GHZJ_GHXGTEST-%dtm%.dmp log=H:/数据库备份/159数据库备份/%dtm%/GHZJ_GHXGTEST-%dtm%.log
:: echo ===开始压缩 GHZJ_GHXGTEST-%dtm%.dmp和 GHZJ_GHXGTEST-%dtm%.log===
:: HaoZipC a -tzip  GHZJ_GHXGTEST-%dtm%.zip H:\数据库备份\159数据库备份\%dtm%\GHZJ_GHXGTEST-%dtm%.dmp  H:\数据库备份\159数据库备份\%dtm%\GHZJ_GHXGTEST-%dtm%.log 
:: echo ===压缩完成,删除备份的文件 GHZJ_GHXGTEST-%dtm%.dmp GHZJ_GHXGTEST-%dtm%.log===
:: del H:\数据库备份\159数据库备份\%dtm%\GHZJ_GHXGTEST-%dtm%.dmp
:: del H:\数据库备份\159数据库备份\%dtm%\GHZJ_GHXGTEST-%dtm%.log

echo ===%TIME%=== >> %LOG_FILE_228%
echo ===开始备份228=== >> %LOG_FILE_228%
echo ===在《H:\数据库备份\228数据库备份\》中新建以当前日期为名的文件夹%dtm%=== >> %LOG_FILE_228%
H:
cd H:\数据库备份\228数据库备份 >> %LOG_FILE_228%
md H:\数据库备份\228数据库备份\%dtm% >> %LOG_FILE_228%

REM tables = (tbl1, tbl2) 导出指定的表
REM owner = (user1, user2) 导出指定的用户，owner和full参数只能存在一个
REM full = y 全库导出

:: 全库备份
echo ===%TIME%=== >> %LOG_FILE_228%
echo ===开始备份228(GHZJ_GHXG)=== >> %LOG_FILE_228%
exp system/xxx@172.16.8.228/ghxg  full=y  file=H:/数据库备份/228数据库备份/%dtm%/GHZJ_GHXG-%dtm%.dmp log=H:/数据库备份/228数据库备份/%dtm%/GHZJ_GHXG-%dtm%.log >> %LOG_FILE_228%
echo ===开始压缩 GHZJ_GHXG-%dtm%.dmp和 GHZJ_GHXG-%dtm%.log=== >> %LOG_FILE_228%
HaoZipC a -tzip  GHZJ_GHXG-%dtm%.zip H:\数据库备份\228数据库备份\%dtm%\GHZJ_GHXG-%dtm%.dmp  H:\数据库备份\228数据库备份\%dtm%\GHZJ_GHXG-%dtm%.log >> %LOG_FILE_228%
echo ===压缩完成,删除备份的文件 GHZJ_GHXG-%dtm%.dmp GHZJ_GHXG-%dtm%.log=== >> %LOG_FILE_228%
del H:\数据库备份\228数据库备份\%dtm%\GHZJ_GHXG-%dtm%.dmp >> %LOG_FILE_228%
del H:\数据库备份\228数据库备份\%dtm%\GHZJ_GHXG-%dtm%.log >> %LOG_FILE_228%

echo ===%TIME%=== >> %LOG_FILE_228%
echo ===开始备份228(GHZJ_ORCL)=== >> %LOG_FILE_228%
exp system/xxx@172.16.8.228/ORCL  full=y  file=H:/数据库备份/228数据库备份/%dtm%/GHZJ_ORCL-%dtm%.dmp log=H:/数据库备份/228数据库备份/%dtm%/GHZJ_ORCL-%dtm%.log >> %LOG_FILE_228%
echo ===开始压缩 GHZJ_ORCL-%dtm%.dmp和 GHZJ_ORCL-%dtm%.log=== >> %LOG_FILE_228%
HaoZipC a -tzip  GHZJ_ORCL-%dtm%.zip H:\数据库备份\228数据库备份\%dtm%\GHZJ_ORCL-%dtm%.dmp  H:\数据库备份\228数据库备份\%dtm%\GHZJ_ORCL-%dtm%.log >> %LOG_FILE_228% 
echo ===压缩完成,删除备份的文件 GHZJ_ORCL-%dtm%.dmp GHZJ_ORCL-%dtm%.log=== >> %LOG_FILE_228%
del H:\数据库备份\228数据库备份\%dtm%\GHZJ_ORCL-%dtm%.dmp >> %LOG_FILE_228%
del H:\数据库备份\228数据库备份\%dtm%\GHZJ_ORCL-%dtm%.log >> %LOG_FILE_228%

:: 单独备份实例
:: echo ===开始备份228(GHZJ_GHXG)===
:: exp GHZJ_GHXG/xxx@172.16.8.228/ghxg  owner=GHZJ_GHXG  file=H:/数据库备份/228数据库备份/%dtm%/GHZJ_GHXG-%dtm%.dmp log=H:/数据库备份/228数据库备份/%dtm%/GHZJ_GHXG-%dtm%.log
:: echo ===开始压缩 GHZJ_GHXG-%dtm%.dmp和 GHZJ_GHXG-%dtm%.log===
:: HaoZipC a -tzip  GHZJ_GHXG-%dtm%.zip H:\数据库备份\228数据库备份\%dtm%\GHZJ_GHXG-%dtm%.dmp  H:\数据库备份\228数据库备份\%dtm%\GHZJ_GHXG-%dtm%.log 
:: echo ===压缩完成,删除备份的文件 GHZJ_GHXG-%dtm%.dmp GHZJ_GHXG-%dtm%.log===
:: del H:\数据库备份\228数据库备份\%dtm%\GHZJ_GHXG-%dtm%.dmp
:: del H:\数据库备份\228数据库备份\%dtm%\GHZJ_GHXG-%dtm%.log
:: 
:: 
:: echo ===开始备份228(GHZJ_TEST)===
:: exp GHZJ_TEST/xxx@172.16.8.228/ORCL  owner=GHZJ_TEST file=H:/数据库备份/228数据库备份/%dtm%/GHZJ_TEST-%dtm%.dmp log=H:/数据库备份/228数据库备份/%dtm%/GHZJ_TEST-%dtm%.log
:: echo ===开始压缩 GHZJ_TEST-%dtm%.dmp和 GHZJ_TEST-%dtm%.log===
:: HaoZipC a -tzip  GHZJ_TEST-%dtm%.zip H:\数据库备份\228数据库备份\%dtm%\GHZJ_TEST-%dtm%.dmp  H:\数据库备份\228数据库备份\%dtm%\GHZJ_TEST-%dtm%.log 
:: echo ===压缩完成,删除备份的文件 GHZJ_TEST-%dtm%.dmp GHZJ_TEST-%dtm%.log===
:: del H:\数据库备份\228数据库备份\%dtm%\GHZJ_TEST-%dtm%.dmp
:: del H:\数据库备份\228数据库备份\%dtm%\GHZJ_TEST-%dtm%.log

echo ===压缩完成,删除日期空目录《H:\数据库备份\159数据库备份\%dtm%》=== >> %LOG_FILE_159%
rd /s H:\数据库备份\159数据库备份\%dtm% >> %LOG_FILE_159%
echo ===压缩完成,删除日期空目录《H:\数据库备份\228数据库备份\%dtm%》=== >> %LOG_FILE_228%
rd /s H:\数据库备份\228数据库备份\%dtm% >> %LOG_FILE_228%


echo ===使用forfiles删除159 30天之前的备份压缩文件,/D参数是天数，/m是文件类型=== >> %LOG_FILE_159%
forfiles /p H:\数据库备份\159数据库备份\ /m  *.zip /d -30 -c "cmd /c if @isdir==FALSE  DEL /S /Q @path" >> %LOG_FILE_159%
forfiles /p H:\数据库备份\159数据库备份 /m *.zip /d -30 /c "cmd /c IF @isdir==TRUE RD /S /Q @path" 
echo ===使用forfiles删除228 30天之前的备份压缩文件,/D参数是天数，/m是文件类型=== >> %LOG_FILE_228%
forfiles /p H:\数据库备份\228数据库备份\ /m  *.zip /d -30 -c "cmd /c if @isdir==FALSE  DEL /S /Q @path"  >> %LOG_FILE_228%

REM echo 备份SXKPN库
REM expdp SXKPN/xxx@PNBDC Directory=PNSJB dumpfile=SXKPN-%dtm%.dump logfile=SXKPN-%dtm%.log 
REM HaoZipC a -tzip  SXKPN-%dtm%.zip E:\PNBDCBACKUP\SXKPN-%dtm%.dump  E:\PNBDCBACKUP\SXKPN-%dtm%.log 
REM del E:\PNBDCBACKUP\SXKPN-%dtm%.dump 
REM del E:\PNBDCBACKUP\SXKPN-%dtm%.log 

REM echo 移动当天所有数据库备份压缩文件到新建日期文件夹中
REM move E:\PNBDCBACKUP\*%dtm%.zip E:\PNBDCBACKUP\%dtm%

REM echo 使用forfiles删除30天之前的备份压缩文件,/D参数是天数，/m是文件类型
REM forfiles /p E:\PNBDCpump /m *.zip /d -30 /c "cmd /c IF @isdir==TRUE RD /S /Q @path"
```

​	**注：exp、expdp导出全库必备前提：①导出用户权限是EXP_FULL_DATABAS或者dba；②需要设置参数full=y，owner和full参数只能存在一个**

#### 配置定时任务

​	通过任务计划程序配置

## linux

centos 定时任务每月1号全备

要在CentOS上设置一个定时任务以在每月的第一天执行全备，你可以使用`cron`来实现。以下是一个示例，它创建了一个cron任务，该任务每月的第一天运行一个全备脚本。

### 创建一个备份脚本

首先，你需要创建一个备份脚本，例如`backup.sh`，并确保它可以正常工作。

```
#!/bin/bash
# backup.sh
# 这里添加你的备份命令，例如使用tar或rsync
if [ -f ~/.bash_profile ];
then
  . ~/.bash_profile
fi
export ORACLE_HOME=/data/oracle/product/11.2.0/db_1
export ORACLE_SID=JCKDCS
export PATH=$PATH:$HOME/bin:$ORACLE_HOME/bin
export DATA_DIR=JCKDCS_BAK
export nowFileName=`date +%Y%m%d%H`
echo "start......"
expdp JCKDCS/xxx@JCKDCS schemas=JCKDCS dumpfile=JCKDCS.JCKDCS_$nowFileName.dmp directory=JCKDCS_BAK logfile=JCKDCS.JCKDCS_$nowFileName.log
expdp JCKDCSCS/xxx@JCKDCS schemas=JCKDCSCS dumpfile=JCKDCS.JCKDCSCS__$nowFileName.dmp directory=JCKDCS_BAK logfile=JCKDCS.JCKDCSCS_$nowFileName.log
echo "finished....."
```

确保脚本可执行：

```
chmod +x backup.sh
```

### 编辑crontab文件

打开当前用户的crontab文件：

```
crontab -e
```

在crontab文件中添加以下行：

```
0 0 1 * * /path/to/backup.sh
```

这个cron任务的意思是在每月的第一天午夜（00:00）运行`backup.sh`。

保存并退出编辑器，cron将自动安装新的定时任务。

### 检查cron服务

确保cron服务正在运行：

```
systemctl enable crond
systemctl start crond
systemctl status crond
```

现在，每当月份的第一天到来时，`backup.sh`脚本将会被自动执行。