---
title: iptables和firewalld防火墙使用整理
tag:
  - linux
  - iptables
  - firewalld
categories:
  - [linux,firewalld]
  - [linux,iptables]
article_type: 0
no_word_count: false
no_toc: false
no_date: false
no_declare: false
no_reward: false
no_comments: false
no_share: false
no_footer: false
mathjax: false
typora-root-url: ./..
abbrlink: da8e3e0
date: 2024-04-08 09:30:11
top:
---

# 一、iptables

## 0、基础知识

```plsql
添加规则时需要配置ip或者ip端，需要了解相关知识
1、需要配置掩码的位数，
173.16.33.171-->173.16.33.171
173.16.33.0-->173.16.33.0/24
173.16.0.0-->173.16.0.0/16
173.0.0.0-->173.0.0.0/8
0.0.0.0-->0.0.0.0/0
```

## 1、简介

**iptables 可以检测、修改、转发、重定向和丢弃 IPv4 数据包**。
过滤 IPv4 数据包的代码已经内置于内核中，并且按照不同的目的被组织成 **表** 的集合。**表** 由一组预先定义的 **链** 组成，**链**包含遍历顺序规则。每一条规则包含一个谓词的潜在匹配和相应的动作（称为 **目标**），如果谓词为真，该动作会被执行。也就是说条件匹配

## 2、安装Iptables

```plsql
（1）禁用 firewalld
CentOS 7 上默认安装了 firewalld 作为防火墙，使用 iptables 建议关闭并禁用 firewalld。
systemctl stop firewalld
systemctl disable firewalld

（2）安装 iptables
yum install iptables-services

（3）服务管理
systemctl enable iptables
systemctl start iptables
systemctl status iptables



查看服务状态：systemctl status iptables
自启用服务：systemctl enable iptables
禁用服务：systemctl disable iptables
启动服务：systemctl start iptables
重启服务：systemctl restart iptables
关闭服务: systemctl stop iptables
```

<!--more-->

## 3、命令

```plsql
iptables -t 表名 <-A/I/D/R> 规则链名 [规则号] <-i/o 网卡名> -p 协议名 <-s 源IP/源子网> --sport 源端口 <-d 目标IP/目标子网> --dport 目标端口 -j 动作

-t, --table table：对指定的表 table 进行操作， table 必须是 raw， nat，filter，mangle 中的一个。如果不指定此选项，默认的是 filter 表。
 
# 通用匹配：源地址目标地址的匹配
-p：指定要匹配的数据包协议类型；
-s, --source [!] address[/mask] ：把指定的一个／一组地址作为源地址，按此规则进行过滤。当后面没有 mask 时，address 是一个地址，比如：192.168.1.1；当 mask 指定时，可以表示一组范围内的地址，比如：192.168.1.0/255.255.255.0。
-d, --destination [!] address[/mask] ：地址格式同上，但这里是指定地址为目的地址，按此进行过滤。
-i, --in-interface [!] <网络接口name> ：指定数据包的来自来自网络接口，比如最常见的 eth0 。注意：它只对 INPUT，FORWARD，PREROUTING 这三个链起作用。如果没有指定此选项， 说明可以来自任何一个网络接口。同前面类似，"!" 表示取反。
-o, --out-interface [!] <网络接口name> ：指定数据包出去的网络接口。只对 OUTPUT，FORWARD，POSTROUTING 三个链起作用。
 
# 查看管理命令
-L, --list [chain] 列出链 chain 上面的所有规则，如果没有指定链，列出表上所有链的所有规则。
 
# 规则管理命令
-A, --append chain rule-specification 在指定链 chain 的末尾插入指定的规则，也就是说，这条规则会被放到最后，最后才会被执行。规则是由后面的匹配来指定。
-I, --insert chain [rulenum] rule-specification 在链 chain 中的指定位置插入一条或多条规则。如果指定的规则号是1，则在链的头部插入。这也是默认的情况，如果没有指定规则号。
-D, --delete chain rule-specification -D, --delete chain rulenum 在指定的链 chain 中删除一个或多个指定规则。
-R num：Replays替换/修改第几条规则
 
# 链管理命令(这都是立即生效的)
-P, --policy chain target ：为指定的链 chain 设置策略 target。注意，只有内置的链才允许有策略，用户自定义的是不允许的。
-F, --flush [chain] 清空指定链 chain 上面的所有规则。如果没有指定链，清空该表上所有链的所有规则。
-N, --new-chain chain 用指定的名字创建一个新的链。
-X, --delete-chain [chain] ：删除指定的链，这个链必须没有被其它任何规则引用，而且这条上必须没有任何规则。如果没有指定链名，则会删除该表中所有非内置的链。
-E, --rename-chain old-chain new-chain ：用指定的新名字去重命名指定的链。这并不会对链内部造成任何影响。
-Z, --zero [chain] ：把指定链，或者表中的所有链上的所有计数器清零。
 
-j, --jump target <指定目标> ：即满足某条件时该执行什么样的动作。target 可以是内置的目标，比如 ACCEPT，也可以是用户自定义的链。
-h：显示帮助信息；
```

## 4、查看规则

> iptables -nL


```
[root@vm01 yum.repos.d]# iptables -nL
Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED
ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0           
ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           
ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            state NEW tcp dpt:22
REJECT     all  --  0.0.0.0/0            0.0.0.0/0            reject-with icmp-host-prohibited

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         
REJECT     all  --  0.0.0.0/0            0.0.0.0/0            reject-with icmp-host-prohibited

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination
```

## 5、检查、备份、情况规则

```
#1、对比检查规则是否已经被保持到配置文件，没有得话重启后会被清空
iptables -nL
cat /etc/sysconfig/iptables

#2、备份规则
cp /etc/sysconfig/iptables /etc/sysconfig/iptables.bak # 任何改动之前先备份，请保持这一优秀的习惯

#3、重置规则
iptables -F  # 清空所有的防火墙规则
iptables -X  # 删除用户自定义的空链
iptables -Z  # 清空计数

#4、保存新规则
iptables-save > /etc/sysconfig/iptables

#5、查看规则信息
cat /etc/sysconfig/iptables

cp /etc/sysconfig/iptables /etc/sysconfig/iptables.bak
iptables-save > /etc/sysconfig/iptables
cat /etc/sysconfig/iptables
```



## 6、清空所有规则(慎用)

> [root@tp ~]# iptables -F      清除预设表filter中的所有规则链的规则
> [root@tp ~]# iptables -X      清除预设表filter中使用者自定链中的规则


## 7、添加

添加规则有两个参数：-A和-I。其中-A是添加到规则的末尾；-I可以插入到指定位置，没有指定位置的话默认插入到规则的首部。  

### 添加一条规则到尾部

> iptables -A INPUT -s 192.168.1.5 -j DROP
> iptables -A INPUT -s 192.168.1.0/24 -j DROP
>

### 插入一条规则到第三行，将行数直接写到规则链的后面

> iptables -I INPUT 3 -s 192.168.1.3 -j DROP
> iptables -I INPUT 3 -s 192.168.1.0/24 -j DROP
> #新增173.16.33.0网段规则
> iptables -I INPUT -s 173.16.33.171 -p tcp --dport 9302 -j ACCEPT
> iptables -I INPUT -s 173.16.33.0/24 -p tcp --dport 9302 -j ACCEPT
> #新增173.16.122.74规则
> iptables -I INPUT -s 173.16.122.74 -p tcp --dport 9876 -j ACCEPT
> iptables -I INPUT -s 173.16.122.0/24 -p tcp --dport 9876 -j ACCEPT
> #新增禁止规则
> iptables -I INPUT -p tcp -s 0.0.0.0/0 --dport 8302 -j DROP
> iptables -I INPUT -p tcp -s 173.16.0.0/16 --dport 8302 -j DROP

## 8、删除

> 删除INPUT第二行规则，命令iptables +选项-D+操作类型（INPUT、FORWARD、OUTPUT）+行数
> iptables -D INPUT 1

## 9、修改

> 修改用-R参数
>
> iptables -R INPUT 3 -j ACCEPT



## 10、常用命令记录


```plsql
#1、查询已有规则
iptables -nL
cat /etc/sysconfig/iptables

#2、备份规则
cp /etc/sysconfig/iptables /etc/sysconfig/iptables.bak # 任何改动之前先备份，请保持这一优秀的习惯

#3、重置规则（刚安装防火墙时使用）
iptables -F  # 清空所有的防火墙规则
iptables -X  # 删除用户自定义的空链
iptables -Z  # 清空计数

#4、修改规则
# 修改INPUT
iptables -I INPUT -p tcp -s 0.0.0.0/0 --dport 7090 -j DROP  # 屏蔽所有网段访问7090端口
iptables -I INPUT -s 173.16.122.0/24 -p tcp --dport 7090 -j ACCEPT # 开放173.16.122.xx网段访问7090端口
iptables -I INPUT -s 173.16.33.0/24 -p tcp --dport 7090 -j ACCEPT  # 开放173.16.33.xx网段访问7090端口

#修改容器(DOCKER-USER或者DOCKER)
iptables -I DOCKER-USER -p tcp -s 0.0.0.0/0 --dport 9010 -j DROP
iptables -I DOCKER-USER -s 172.16.10.157 -p tcp --dport 9010 -j ACCEPT


#5、保存新规则
iptables-save > /etc/sysconfig/iptables

#6、删除容器第一条规则
iptables -D DOCKER-USER 1
```

## 11、iptables 示例

### 清空当前的所有规则和计数

> iptables -F  # 清空所有的防火墙规则
> iptables -X  # 删除用户自定义的空链 
> iptables -Z  # 清空计数 

### 配置允许 ssh 端口连接

> iptables -A INPUT -s 192.168.1.0/24 -p tcp --dport 22 -j ACCEPT # 22为你的ssh端口， -s 192.168.1.0/24表示允许这个网段的机器来连接，其它网段的ip地址是登陆不了你的机器的。 -j ACCEPT表示接受这样的请求 

### 允许本地回环地址可以正常使用

> iptables -A INPUT -i lo -j ACCEPT #本地圆环地址就是那个127.0.0.1，是本机上使用的,它进与出都设置为允许 iptables -A OUTPUT -o lo -j ACCEPT 

### 设置默认的规则

> iptables -P INPUT DROP # 配置默认的不让进 iptables -P FORWARD DROP # 默认的不允许转发 
> iptables -P OUTPUT ACCEPT # 默认的可以出去 

### 配置白名单

> iptables -A INPUT -p all -s 192.168.1.0/24 -j ACCEPT  # 允许机房内网机器可以访问 
> iptables -A INPUT -p all -s 192.168.140.0/24 -j ACCEPT  # 允许机房内网机器可以访问 
> iptables -A INPUT -p tcp -s 183.121.3.7 --dport 3380 -j ACCEPT # 允许183.121.3.7访问本机的3380端口 

### 开启相应的服务端口

> iptables -A INPUT -p tcp --dport 80 -j ACCEPT # 开启80端口，因为web对外都是这个端口 
> iptables -A INPUT -p icmp --icmp-type 8 -j ACCEPT # 允许被ping 
> iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT # 已经建立的连接得让它进来 

### 保存规则到配置文件中

> cp /etc/sysconfig/iptables /etc/sysconfig/iptables.bak # 任何改动之前先备份，请保持这一优秀的习惯 iptables-save > /etc/sysconfig/iptables cat /etc/sysconfig/iptables 

### 列出已设置的规则

iptables -L [-t 表名][链名]

- 四个表名 raw，nat，filter，mangle
- 五个规则链名 INPUT、OUTPUT、FORWARD、PREROUTING、POSTROUTING
- filter 表包含INPUT、OUTPUT、FORWARD三个规则链

> ptables -L -t nat                  
>
> 列出 nat 上面的所有规则 
>
> ^ -t 参数指定，必须是 raw， nat，filter，mangle 中的一个 
>
> iptables -L -t nat  --line-numbers  # 规则带编号 
> iptables -L INPUT iptables -L -nv  # 查看，这个列表看起来更详细 

### 清除已有规则

> iptables -F INPUT  # 清空指定链 INPUT 上面的所有规则 
> iptables -X INPUT  # 删除指定的链，这个链必须没有被其它任何规则引用，而且这条上必须没有任何规则。                                 # 如果没有指定链名，则会删除该表中所有非内置的链。 
> iptables -Z INPUT  # 把指定链，或者表中的所有链上的所有计数器清零。 

### 删除已添加的规则

> 添加一条规则 iptables -A INPUT -s 192.168.1.5 -j DROP 

将所有 iptables 以序号标记显示，执行：

> iptables -L -n --line-numbers 

比如要删除 INPUT 里序号为 8 的规则，执行：

> iptables -D INPUT 8 

### 开放指定的端口

> iptables -A INPUT -s 127.0.0.1 -d 127.0.0.1 -j ACCEPT               #允许本地回环接口(即运行本机访问本机)
> iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT    #允许已建立的或相关连的通行
> iptables -A OUTPUT -j ACCEPT         #允许所有本机向外的访问
> iptables -A INPUT -p tcp --dport 22 -j ACCEPT    #允许访问22端口
> iptables -A INPUT -p tcp --dport 80 -j ACCEPT    #允许访问80端口
> iptables -A INPUT -p tcp --dport 21 -j ACCEPT    #允许ftp服务的21端口
> iptables -A INPUT -p tcp --dport 20 -j ACCEPT    #允许FTP服务的20端口
> iptables -A INPUT -j reject       #禁止其他未允许的规则访问
> iptables -A FORWARD -j REJECT     #禁止其他未允许的规则访问

### 屏蔽 IP

> iptables -A INPUT -p tcp -m tcp -s 192.168.0.8 -j DROP  # 屏蔽恶意主机（比如，192.168.0.8
> iptables -I INPUT -s 123.45.6.7 -j DROP       #屏蔽单个IP的命令
> iptables -I INPUT -s 123.0.0.0/8 -j DROP      #封整个段即从123.0.0.1到123.255.255.254的命令
> iptables -I INPUT -s 124.45.0.0/16 -j DROP    #封IP段即从123.45.0.1到123.45.255.254的命令
> iptables -I INPUT -s 123.45.6.0/24 -j DROP    #封IP段即从123.45.6.1到123.45.6.254的命令是

### 指定数据包出去的网络接口

只对 OUTPUT，FORWARD，POSTROUTING 三个链起作用。

> iptables -A FORWARD -o eth0 

### 查看已添加的规则

> iptables -L -n -v
> Chain INPUT (policy DROP 48106 packets, 2690K bytes)
> pkts bytes target     prot opt in     out     source               destination
> 5075  589K ACCEPT     all  --  lo     *       0.0.0.0/0            0.0.0.0/0
> 191K   90M ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:22
> 1499K  133M ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:80
> 4364K 6351M ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED
> 6256  327K ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0
>
> Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
> pkts bytes target     prot opt in     out     source               destination
>
> Chain OUTPUT (policy ACCEPT 3382K packets, 1819M bytes)
> pkts bytes target     prot opt in     out     source               destination
> 5075  589K ACCEPT     all  --  *      lo      0.0.0.0/0            0.0.0.0/0

### 启动网络转发规则

公网210.14.67.7让内网192.168.188.0/24上网

> iptables -t nat -A POSTROUTING -s 192.168.188.0/24 -j SNAT --to-source 210.14.67.127 

###  端口映射

本机的 2222 端口映射到内网 虚拟机的 22 端口

> ptables -t nat -A PREROUTING -d 210.14.67.127 -p tcp --dport 2222  -j DNAT --to-dest 192.168.188.115:22 

### 字符串匹配

比如，我们要过滤所有 TCP 连接中的字符串test，一旦出现它我们就终止这个连接，我们可以这么做：

> iptables -A INPUT -p tcp -m string --algo kmp --string "test" -j REJECT --reject-with tcp-reset
> iptables -L
>
> Chain INPUT (policy ACCEPT)
>
> target     prot opt source               destination
>
> REJECT     tcp  --  anywhere             anywhere            STRING match "test" ALGO name kmp TO 65535 reject-with tcp-reset
>
> Chain FORWARD (policy ACCEPT)
>
> target     prot opt source               destination
>
> Chain OUTPUT (policy ACCEPT)
>
> target     prot opt source               destination

### 阻止 Windows 蠕虫的攻击

> ptables -I INPUT -j DROP -p tcp -s 0.0.0.0/0 -m string --algo kmp --string "cmd.exe" 

### 防止 SYN 洪水攻击

> ptables -A INPUT -p tcp --syn -m limit --limit 5/second -j ACCEPT 

## 12、参考资料

- https://wiki.archlinux.org/index.php/iptables_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)
- https://wangchujiang.com/linux-command/c/iptables.html



# 二、firewalld

```plsql
1、firewalld的基本使用
启动： systemctl start firewalld
关闭： systemctl stop firewalld
查看状态： systemctl status firewalld 
开机禁用  ： systemctl disable firewalld
开机启用  ： systemctl enable firewalld
 
 
2.systemctl是CentOS7的服务管理工具中主要的工具，它融合之前service和chkconfig的功能于一体。
启动一个服务：systemctl start firewalld.service
关闭一个服务：systemctl stop firewalld.service
重启一个服务：systemctl restart firewalld.service
显示一个服务的状态：systemctl status firewalld.service
在开机时启用一个服务：systemctl enable firewalld.service
在开机时禁用一个服务：systemctl disable firewalld.service
查看服务是否开机启动：systemctl is-enabled firewalld.service
查看已启动的服务列表：systemctl list-unit-files|grep enabled
查看启动失败的服务列表：systemctl --failed

3.配置firewalld-cmd

查看版本： firewall-cmd --version
查看帮助： firewall-cmd --help
显示状态： firewall-cmd --state
查看所有打开的端口： firewall-cmd --zone=public --list-ports
更新防火墙规则： firewall-cmd --reload
查看区域信息:  firewall-cmd --get-active-zones
查看指定接口所属区域： firewall-cmd --get-zone-of-interface=eth0
拒绝所有包：firewall-cmd --panic-on
取消拒绝状态： firewall-cmd --panic-off
查看是否拒绝： firewall-cmd --query-panic
 
那怎么开启一个端口呢
添加
firewall-cmd --zone=public --add-port=80/tcp --permanent    （--permanent永久生效，没有此参数重启后失效）
重新载入
firewall-cmd --reload
查看
firewall-cmd --zone= public --query-port=80/tcp
删除
firewall-cmd --zone= public --remove-port=80/tcp --permanent
```

